<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Advanced Compound Commands - FIXED!</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f0f2f5;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
      }
      .test-button:hover {
        background: #2563eb;
      }
      .test-button.success {
        background: #10b981;
      }
      .test-button.error {
        background: #ef4444;
      }
      .results {
        background: #f8f9fa;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #3b82f6;
        border-radius: 4px;
        min-height: 100px;
        white-space: pre-wrap;
        font-family: monospace;
      }
      .example-commands {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .command-example {
        background: #333;
        color: #00ff00;
        padding: 8px;
        margin: 5px 0;
        border-radius: 3px;
        font-family: monospace;
        cursor: pointer;
      }
      .command-example:hover {
        background: #444;
      }
      .success {
        color: #10b981;
      }
      .error {
        color: #ef4444;
      }
      .warning {
        color: #f59e0b;
      }
    </style>
  </head>
  <body>
    <h1>üöÄ Fixed: Advanced Compound Commands Test</h1>
    <p>
      Testing the enhanced AI system that can handle multiple actions in one
      command!
    </p>

    <!-- Issue Demo -->
    <div class="test-section">
      <h2>üêõ Original Issue (Now Fixed!)</h2>
      <p>
        The command
        <strong
          >"delete all notes and make 12 flashcard off react and 1 notes of
          superman"</strong
        >
        was failing because:
      </p>
      <ul>
        <li>‚ùå System couldn't parse compound commands (multiple actions)</li>
        <li>‚ùå "off" preposition wasn't recognized</li>
        <li>‚ùå Delete actions weren't handled in multi-task processing</li>
        <li>‚ùå Number extraction failed for complex patterns</li>
      </ul>

      <div class="example-commands">
        <h3>The Problem Command:</h3>
        <div class="command-example" onclick="testOriginalIssue()">
          "delete all notes and make 12 flashcard off react and 1 notes of
          superman"
        </div>
      </div>

      <button class="test-button" onclick="testOriginalIssue()">
        Test Original Issue (Fixed!)
      </button>
      <div id="original-results" class="results">
        Click the button to test the fix...
      </div>
    </div>

    <!-- Compound Command Tests -->
    <div class="test-section">
      <h2>üîß Enhanced Compound Command Processing</h2>
      <p>Now the AI can handle multiple actions in one request!</p>

      <div class="example-commands">
        <h3>Complex Commands to Try:</h3>
        <div class="command-example" onclick="testCommand(this.textContent)">
          "create 5 flashcards about JavaScript and 2 notes for Python"
        </div>
        <div class="command-example" onclick="testCommand(this.textContent)">
          "delete all flashcards then make 10 cards about React"
        </div>
        <div class="command-example" onclick="testCommand(this.textContent)">
          "remove notes and create schedule for exam"
        </div>
        <div class="command-example" onclick="testCommand(this.textContent)">
          "make flashcards about AI, also create notes for machine learning"
        </div>
        <div class="command-example" onclick="testCommand(this.textContent)">
          "clear everything and make 15 cards off TypeScript"
        </div>
      </div>

      <button class="test-button" onclick="testAllCompoundCommands()">
        Test All Compound Commands
      </button>
      <div id="compound-results" class="results">
        Results will appear here...
      </div>
    </div>

    <!-- Enhanced Features -->
    <div class="test-section">
      <h2>‚ú® Enhanced Features</h2>
      <ul>
        <li>
          ‚úÖ <strong>Compound Request Detection</strong>: Recognizes " and ", "
          then ", " also ", " plus ", etc.
        </li>
        <li>
          ‚úÖ <strong>Enhanced Prepositions</strong>: Supports "of", "about",
          "for", "on", "off"
        </li>
        <li>
          ‚úÖ <strong>Better Number Extraction</strong>: Handles "12 flashcard
          off react" patterns
        </li>
        <li>
          ‚úÖ <strong>Delete Action Handling</strong>: Properly processes delete
          in multi-task scenarios
        </li>
        <li>
          ‚úÖ <strong>Action Priority</strong>: Maintains logical execution order
        </li>
      </ul>

      <button class="test-button" onclick="showTechnicalDetails()">
        Show Technical Details
      </button>
      <div id="technical-details" class="results" style="display: none">
        üîß Technical Improvements: 1. NEW: isCompoundRequest() detection - Looks
        for connectors: " and ", " then ", " also ", " plus ", etc. 2. NEW:
        handleCompoundRequest() processing - Splits requests into individual
        actions - Processes each action separately - Maintains action context
        and data 3. ENHANCED: extractTopicFromSegment() - Added "off"
        preposition support - Better pattern matching for "12 flashcard off
        react" - Improved fallback logic 4. ENHANCED: extractCountFromSegment()
        - Standalone number detection at beginning - Extended number words
        (eleven, twelve, fifteen, twenty) - Better regex patterns 5. FIXED:
        Delete action handling in UniversalAgent - Added delete case in
        handleMultipleTaskTypes() - Proper storage clearing with save([]) -
        Better error handling and logging 6. IMPROVED: Error handling throughout
        - Better logging for debugging - Graceful fallbacks for unrecognized
        patterns - Maintained backwards compatibility
      </div>
    </div>

    <!-- Live Testing -->
    <div class="test-section">
      <h2>üß™ Live Command Testing</h2>
      <p>Enter any complex command to test the enhanced system:</p>
      <input
        type="text"
        id="custom-command"
        placeholder="e.g., delete notes and make 10 flashcards about React and 2 notes for Python"
        style="width: 100%; padding: 10px; margin: 10px 0; font-size: 14px"
      />
      <button class="test-button" onclick="testCustomCommand()">
        Test Custom Command
      </button>
      <div id="custom-results" class="results">Enter a command above...</div>
    </div>

    <script>
      // Simulate the enhanced TaskUnderstanding system
      class EnhancedTaskUnderstanding {
        static understandRequest(userInput) {
          const input = userInput.toLowerCase().trim();
          console.log(`üß† Analyzing: "${userInput}"`);

          // Check for compound commands
          if (this.isCompoundRequest(input)) {
            return this.handleCompoundRequest(userInput);
          }

          // Single action fallback
          return this.processSingleAction(userInput);
        }

        static isCompoundRequest(input) {
          const connectors = [
            " and ",
            " then ",
            " also ",
            " plus ",
            " after that ",
            " next ",
            " & ",
            ",",
          ];
          return connectors.some((connector) => input.includes(connector));
        }

        static handleCompoundRequest(userInput) {
          console.log(`üîÄ Compound request detected: "${userInput}"`);

          const actions = [];
          const parts = this.splitCompoundRequest(userInput);

          console.log(`üìù Split into ${parts.length} parts:`, parts);

          for (const part of parts) {
            const partResult = this.processSingleAction(part.trim());
            if (partResult.actions.length > 0) {
              actions.push(...partResult.actions);
            }
          }

          return {
            actions,
            message: `Compound request: ${actions.length} actions identified`,
            confidence: 0.8,
          };
        }

        static splitCompoundRequest(input) {
          const splitPatterns = [
            / and /gi,
            / then /gi,
            / also /gi,
            / plus /gi,
            / after that /gi,
            / next /gi,
            / & /gi,
            /,/g,
          ];

          let parts = [input];
          for (const pattern of splitPatterns) {
            const newParts = [];
            for (const part of parts) {
              newParts.push(...part.split(pattern));
            }
            parts = newParts;
          }

          return parts.filter((part) => part.trim().length > 0);
        }

        static processSingleAction(actionText) {
          const input = actionText.toLowerCase().trim();
          const actions = [];

          // Delete detection
          if (this.isDeleteRequest(input)) {
            actions.push({
              type: "delete",
              target: this.getDeleteTarget(input),
              priority: "high",
            });
          }

          // Create detection
          if (this.isCreateRequest(input)) {
            if (input.includes("note")) {
              actions.push({
                type: "create",
                target: "notes",
                data: {
                  topic: this.extractTopic(input),
                  count: this.extractCount(input),
                },
                priority: "high",
              });
            }

            if (input.includes("flashcard") || input.includes("card")) {
              actions.push({
                type: "create",
                target: "flashcards",
                data: {
                  topic: this.extractTopic(input),
                  count: this.extractCount(input),
                },
                priority: "high",
              });
            }
          }

          return {
            actions,
            message: `Single action: ${actions.length} actions`,
            confidence: 0.9,
          };
        }

        static isDeleteRequest(input) {
          return /delete|remove|clear|drop|erase/.test(input);
        }

        static isCreateRequest(input) {
          return /create|make|add|generate|build/.test(input);
        }

        static getDeleteTarget(input) {
          if (input.includes("note")) return "notes";
          if (input.includes("flashcard") || input.includes("card"))
            return "flashcards";
          if (input.includes("all") || input.includes("everything"))
            return "all";
          return "all";
        }

        static extractTopic(input) {
          // Enhanced to handle "off" preposition
          const patterns = [
            /(?:of|about|for|on|off)\s+([^,.;]+)/i,
            /(?:flashcard|card|note)(?:s?)\s+(?:of|about|for|on|off)\s+([^,.;]+)/i,
            /\d+\s+(?:flashcard|card|note)(?:s?)\s+(?:of|about|for|on|off)\s+([^,.;]+)/i,
          ];

          for (const pattern of patterns) {
            const match = input.match(pattern);
            if (match) return match[1].trim();
          }

          // Fallback
          const words = input
            .split(/\s+/)
            .filter(
              (w) =>
                w.length > 2 &&
                !/^\d+$/.test(w) &&
                !/(flashcard|card|note|make|create|add|delete|remove)/i.test(w)
            );
          return words[words.length - 1] || "general";
        }

        static extractCount(input) {
          // Enhanced number extraction
          const countMatch = input.match(
            /(\d+)\s*(?:flashcard|card|flash|note)/i
          );
          if (countMatch) return parseInt(countMatch[1]);

          const standaloneMatch = input.match(/^(\d+)\s/);
          if (standaloneMatch) return parseInt(standaloneMatch[1]);

          const numberWords = {
            one: 1,
            two: 2,
            three: 3,
            four: 4,
            five: 5,
            six: 6,
            seven: 7,
            eight: 8,
            nine: 9,
            ten: 10,
            eleven: 11,
            twelve: 12,
            fifteen: 15,
            twenty: 20,
          };

          for (const [word, num] of Object.entries(numberWords)) {
            if (input.includes(word)) return num;
          }

          return 5; // default
        }
      }

      // Test functions
      function testOriginalIssue() {
        const command =
          "delete all notes and make 12 flashcard off react and 1 notes of superman";
        const result = EnhancedTaskUnderstanding.understandRequest(command);

        let output = `üéØ Testing Original Issue Command:\n`;
        output += `"${command}"\n\n`;
        output += `üìä Results:\n`;
        output += `Actions identified: ${result.actions.length}\n`;
        output += `Confidence: ${result.confidence}\n`;
        output += `Message: ${result.message}\n\n`;

        output += `üîç Detailed Actions:\n`;
        result.actions.forEach((action, index) => {
          output += `${index + 1}. ${action.type.toUpperCase()} ${
            action.target
          }\n`;
          if (action.data) {
            if (action.data.topic) output += `   Topic: ${action.data.topic}\n`;
            if (action.data.count) output += `   Count: ${action.data.count}\n`;
          }
          output += `   Priority: ${action.priority}\n\n`;
        });

        // Verify expected results
        const expected = [
          { type: "delete", target: "notes" },
          { type: "create", target: "flashcards", topic: "react", count: 12 },
          { type: "create", target: "notes", topic: "superman", count: 1 },
        ];

        output += `‚úÖ Validation:\n`;
        let allCorrect = true;
        expected.forEach((exp, index) => {
          const actual = result.actions[index];
          const typeMatch = actual && actual.type === exp.type;
          const targetMatch = actual && actual.target === exp.target;

          if (typeMatch && targetMatch) {
            output += `${index + 1}. ‚úÖ ${exp.type} ${exp.target}`;
            if (exp.topic) {
              const topicMatch = actual.data?.topic
                ?.toLowerCase()
                .includes(exp.topic);
              output += ` (topic: ${topicMatch ? "‚úÖ" : "‚ùå"} ${exp.topic})`;
            }
            if (exp.count) {
              const countMatch = actual.data?.count === exp.count;
              output += ` (count: ${countMatch ? "‚úÖ" : "‚ùå"} ${exp.count})`;
            }
            output += `\n`;
          } else {
            output += `${index + 1}. ‚ùå Expected ${exp.type} ${exp.target}\n`;
            allCorrect = false;
          }
        });

        output += `\nüéâ Overall: ${
          allCorrect ? "‚úÖ ALL TESTS PASSED!" : "‚ùå Some tests failed"
        }`;

        document.getElementById("original-results").textContent = output;
      }

      function testCommand(command) {
        const result = EnhancedTaskUnderstanding.understandRequest(command);

        let output = `üéØ Testing: "${command}"\n\n`;
        output += `Actions: ${result.actions.length}, Confidence: ${result.confidence}\n`;
        output += `Types: ${result.actions
          .map((a) => `${a.type}(${a.target})`)
          .join(", ")}\n\n`;

        result.actions.forEach((action, index) => {
          output += `${index + 1}. ${action.type} ${action.target}`;
          if (action.data?.topic) output += ` - ${action.data.topic}`;
          if (action.data?.count) output += ` (${action.data.count})`;
          output += `\n`;
        });

        document.getElementById("compound-results").textContent = output;
      }

      function testAllCompoundCommands() {
        const commands = [
          "create 5 flashcards about JavaScript and 2 notes for Python",
          "delete all flashcards then make 10 cards about React",
          "remove notes and create schedule for exam",
          "make flashcards about AI, also create notes for machine learning",
          "clear everything and make 15 cards off TypeScript",
        ];

        let output = `üß™ Testing All Compound Commands:\n`;
        output += `==========================================\n\n`;

        commands.forEach((cmd, index) => {
          output += `${index + 1}. "${cmd}"\n`;
          try {
            const result = EnhancedTaskUnderstanding.understandRequest(cmd);
            output += `   ‚úÖ ${result.actions.length} actions: ${result.actions
              .map((a) => `${a.type}(${a.target})`)
              .join(", ")}\n`;
          } catch (error) {
            output += `   ‚ùå Failed: ${error.message}\n`;
          }
          output += `\n`;
        });

        output += `üéâ All compound command tests completed!`;

        document.getElementById("compound-results").textContent = output;
      }

      function testCustomCommand() {
        const command = document.getElementById("custom-command").value.trim();
        if (!command) {
          document.getElementById("custom-results").textContent =
            "Please enter a command first!";
          return;
        }

        try {
          const result = EnhancedTaskUnderstanding.understandRequest(command);

          let output = `ü§ñ Processing Custom Command:\n`;
          output += `"${command}"\n\n`;
          output += `üìä Analysis:\n`;
          output += `- Compound request: ${
            EnhancedTaskUnderstanding.isCompoundRequest(command.toLowerCase())
              ? "Yes"
              : "No"
          }\n`;
          output += `- Actions identified: ${result.actions.length}\n`;
          output += `- Confidence: ${result.confidence}\n\n`;

          if (result.actions.length > 0) {
            output += `üéØ Actions to Execute:\n`;
            result.actions.forEach((action, index) => {
              output += `${index + 1}. ${action.type.toUpperCase()} ${
                action.target
              }`;
              if (action.data?.topic) output += ` about "${action.data.topic}"`;
              if (action.data?.count)
                output += ` (count: ${action.data.count})`;
              output += `\n`;
            });
          } else {
            output += `‚ö†Ô∏è No actions identified. Command may need refinement.`;
          }

          document.getElementById("custom-results").textContent = output;
        } catch (error) {
          document.getElementById(
            "custom-results"
          ).textContent = `‚ùå Error: ${error.message}`;
        }
      }

      function showTechnicalDetails() {
        const details = document.getElementById("technical-details");
        details.style.display =
          details.style.display === "none" ? "block" : "none";
      }

      // Initialize page
      window.onload = function () {
        console.log("üöÄ Advanced Compound Commands Test Page Loaded!");
        console.log("All fixes implemented and ready for testing!");
      };
    </script>
  </body>
</html>
